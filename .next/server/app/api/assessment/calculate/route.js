"use strict";(()=>{var e={};e.id=56,e.ids=[56],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},3350:(e,s,t)=>{t.r(s),t.d(s,{originalPathname:()=>g,patchFetch:()=>h,requestAsyncStorage:()=>I,routeModule:()=>m,serverHooks:()=>f,staticGenerationAsyncStorage:()=>S});var n={};t.r(n),t.d(n,{OPTIONS:()=>p,POST:()=>d});var i=t(9303),o=t(8716),r=t(670),a=t(7070),c=t(1483);class l{constructor(){}static getInstance(){return l.instance||(l.instance=new l),l.instance}validateResponses(e,s){let t=[];if(!e||0===e.length)return t.push({field:"responses",message:"No responses provided",code:"EMPTY_RESPONSES"}),{isValid:!1,errors:t};for(let n=0;n<e.length;n++){let i=e[n],o=this.validateSingleResponse(i,s,n);t.push(...o)}if("sais"===s){let s=this.validateSAISDistributions(e);t.push(...s)}return{isValid:0===t.length,errors:t}}validateSingleResponse(e,s,t){let n=[],i=`responses[${t}]`;return e.questionId||n.push({field:`${i}.questionId`,message:"Question ID is required",code:"MISSING_QUESTION_ID"}),e.sessionId||n.push({field:`${i}.sessionId`,message:"Session ID is required",code:"MISSING_SESSION_ID"}),e.mbtiDimension?this.isValidDimension(e.mbtiDimension)||n.push({field:`${i}.mbtiDimension`,message:"Invalid MBTI dimension",code:"INVALID_DIMENSION"}):n.push({field:`${i}.mbtiDimension`,message:"MBTI dimension is required",code:"MISSING_DIMENSION"}),e.responseType||n.push({field:`${i}.responseType`,message:"Response type is required",code:"MISSING_RESPONSE_TYPE"}),"binary"===e.responseType?e.selectedOption&&["A","B"].includes(e.selectedOption)||n.push({field:`${i}.selectedOption`,message:"Binary response must have selectedOption as A or B",code:"INVALID_BINARY_OPTION"}):"distribution"===e.responseType&&(void 0===e.distributionA||void 0===e.distributionB)&&n.push({field:`${i}.distribution`,message:"Distribution responses must have both distributionA and distributionB",code:"MISSING_DISTRIBUTION"}),n}validateSAISDistributions(e){let s=[],t={};for(let n of e)if("distribution"===n.responseType){let e=(n.distributionA||0)+(n.distributionB||0);t[n.questionId]=e,5!==e&&s.push({field:`question-${n.questionId}`,message:`SAIS distribution must total exactly 5, got ${e}`,code:"INVALID_SAIS_TOTAL"}),this.isValidSAISCombination(n.distributionA||0,n.distributionB||0)||s.push({field:`question-${n.questionId}`,message:`Invalid SAIS distribution combination: ${n.distributionA}/${n.distributionB}`,code:"INVALID_SAIS_COMBINATION"})}return s}isValidSAISCombination(e,s){return[[5,0],[4,1],[3,2],[2,3],[1,4],[0,5]].some(([t,n])=>e===t&&s===n)}isValidDimension(e){return["E/I","S/N","T/F","J/P"].includes(e)}validateSAISResponses(e){let s=this.validateResponses(e,"sais"),t={};for(let s of e)"distribution"===s.responseType&&(t[s.questionId]=(s.distributionA||0)+(s.distributionB||0));return{...s,distributionTotals:t}}validateMethodology(e){return["scenarios","traits","sais"].includes(e)}sanitizeResponses(e){return e.map(e=>({...e,questionId:e.questionId?.toString()||"",sessionId:e.sessionId?.toString()||"",responseId:e.responseId?.toString()||"",distributionA:"number"==typeof e.distributionA?Math.max(0,Math.min(5,e.distributionA)):void 0,distributionB:"number"==typeof e.distributionB?Math.max(0,Math.min(5,e.distributionB)):void 0}))}}let u=new Map;async function d(e){try{let{sessionId:s,responses:t,methodology:n,isInterim:i}=await e.json();if(!s)return a.NextResponse.json({success:!1,error:"Session ID is required",timestamp:new Date().toISOString()},{status:400});if(!t||!Array.isArray(t))return a.NextResponse.json({success:!1,error:"Responses array is required",timestamp:new Date().toISOString()},{status:400});if(!n)return a.NextResponse.json({success:!1,error:"Methodology is required",timestamp:new Date().toISOString()},{status:400});let o=l.getInstance();if(!o.validateMethodology(n))return a.NextResponse.json({success:!1,error:"Invalid methodology. Must be one of: scenarios, traits, sais",timestamp:new Date().toISOString()},{status:400});let r=`${s}-${n}-${t.length}-${JSON.stringify(t)}`,d=u.get(r);if(d&&Date.now()-d.timestamp<3e5){let e={...d.result,cacheHit:!0};return a.NextResponse.json({success:!0,data:e,timestamp:new Date().toISOString()})}let p=o.sanitizeResponses(t),m=o.validateResponses(p,n);if(!m.isValid)return a.NextResponse.json({success:!1,error:"Invalid responses",data:{errors:m.errors},timestamp:new Date().toISOString()},{status:400});let I={...c.p.getInstance().calculateMBTI({sessionId:s,responses:p,methodology:n,isInterim:i||!1}),calculatedAt:new Date,cacheHit:!1};u.set(r,{result:I,timestamp:Date.now()});let S=[];for(let e of(u.forEach((e,s)=>{Date.now()-e.timestamp>3e5&&S.push(s)}),S))u.delete(e);return a.NextResponse.json({success:!0,data:I,timestamp:new Date().toISOString()})}catch(e){return console.error("MBTI calculation error:",e),a.NextResponse.json({success:!1,error:"Internal server error during MBTI calculation",timestamp:new Date().toISOString()},{status:500})}}async function p(e){return new a.NextResponse(null,{status:200,headers:{"Access-Control-Allow-Origin":"*","Access-Control-Allow-Methods":"POST, OPTIONS","Access-Control-Allow-Headers":"Content-Type"}})}let m=new i.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api/assessment/calculate/route",pathname:"/api/assessment/calculate",filename:"route",bundlePath:"app/api/assessment/calculate/route"},resolvedPagePath:"C:\\Users\\am112\\OneDrive\\سطح المكتب\\Clients\\MBTI\\src\\app\\api\\assessment\\calculate\\route.ts",nextConfigOutput:"",userland:n}),{requestAsyncStorage:I,staticGenerationAsyncStorage:S,serverHooks:f}=m,g="/api/assessment/calculate/route";function h(){return(0,r.patchFetch)({serverHooks:f,staticGenerationAsyncStorage:S})}},1483:(e,s,t)=>{t.d(s,{p:()=>n});class n{constructor(){this.consciousnessDomains={"E/I":{name:"مصدر حيويتك وتفاعلك",E:{name:"التفاعل الخارجي",description:"استمداد الحيوية من التفاعل مع الطيف الواسع من النشاطات والأشخاص"},I:{name:"الانغماس الداخلي",description:"الانغماس في عالمك الداخلي الغني والاتصال بمركز جذري عميق وهادئ"}},"S/N":{name:"طريقة استقبالك للمعلومات",S:{name:"الواقع المادي",description:"التفاعل مع الواقع المادي الملموس واستخدام الحواس الخمس"},N:{name:"البصيرة الحدسية",description:"الغوص في بحر الاحتمالات والمعاني الخفية باستخدام العين الثالثة"}},"T/F":{name:"مركز اتخاذ القرار",T:{name:"التحليل المنطقي",description:"تحليل منطقي وموضوعي للحقائق وبناء هيكل عقلي متماسك"},F:{name:"بوصلة القيم الداخلية",description:"الاتصال بمركز القلب والانسجام مع مشاعر الآخرين وقيمك الداخلية"}},"J/P":{name:"تنظيم عالمك الخارجي",J:{name:"الهيكل المنظم",description:"وضع هيكل زمني ونظام واضح للسيطرة والتنبؤ بالأحداث"},P:{name:"المرونة العفوية",description:"ترك مساحة للمرونة والعفوية وإبقاء الخيارات مفتوحة"}}}}static getInstance(){return n.instance||(n.instance=new n),n.instance}calculateMBTI(e){let s;let{sessionId:t,responses:n,methodology:i,isInterim:o=!1}=e,r=this.calculateDimensionScores(n,i),a=this.determineMBTIType(r),c=this.calculateOverallConfidence(r);return"sais"===i&&(s=this.generateConsciousnessProfile(r)),{sessionId:t,mbtiType:a,dimensionScores:r,overallConfidence:c,methodology:i,isInterim:o,totalResponses:n.length,consciousnessProfile:s}}calculateDimensionScores(e,s){let t=[];for(let n of["E/I","S/N","T/F","J/P"]){let i,o,r;let a=e.filter(e=>e.mbtiDimension===n),c=0,l=0;for(let e of a)if("sais"===s&&"distribution"===e.responseType){let s=e.distributionA||0,t=e.distributionB||0;c+=s,l+=t}else"binary"===e.responseType&&("A"===e.selectedOption?c+=1:"B"===e.selectedOption&&(l+=1));let u=this.determinePreference(n,c,l,a),d=this.calculateConfidence(c,l,s);if("sais"===s){r=15;let e=0;for(let s of a)s.tendency===u&&"distribution"===s.responseType&&(e+="A"===s.selectedOption?s.distributionA:s.distributionB);i=Math.round(e/r*100),o=this.consciousnessDomains[n].name}t.push({dimension:n,rawScoreA:c,rawScoreB:l,preference:u,confidence:d,consciousnessPercentage:i,consciousnessDomain:o,totalPossiblePoints:r})}return t}determinePreference(e,s,t,n){if(n&&n.length>0){let e=n.find(e=>"distribution"===e.responseType);if(e&&e.tendency){let e={};for(let s of n)if(s.tendency){if(e[s.tendency]||(e[s.tendency]=0),"distribution"===s.responseType){let t="A"===s.selectedOption?s.distributionA||0:s.distributionB||0;e[s.tendency]+=t}else e[s.tendency]+=1}let s=Object.entries(e);if(s.length>0)return s.sort((e,s)=>s[1]-e[1]),s[0][0]}}let i={"E/I":{A:"E",B:"I"},"S/N":{A:"S",B:"N"},"T/F":{A:"T",B:"F"},"J/P":{A:"J",B:"P"}};return s>t?i[e].A:i[e].B}calculateConfidence(e,s,t){let n=e+s;if(0===n)return 50;let i=Math.max(e,s)/n*100;return"sais"===t&&n>0&&(i=50+Math.abs(e-s)/n*50),Math.round(i)}determineMBTIType(e){return e.map(e=>e.preference).join("")}calculateOverallConfidence(e){return Math.round(e.reduce((e,s)=>e+s.confidence,0)/e.length)}calculateInterimResults(e){let s=["E/I","S/N","T/F","J/P"],t=[];for(let n=0;n<Math.min(4,e.length);n++){let i=e[n];!i.mbtiDimension&&n<s.length&&(i.mbtiDimension=s[n]),t.push(i)}return this.calculateMBTI({sessionId:e[0]?.sessionId||"",responses:t,methodology:"scenarios",isInterim:!0})}isSAISScoreValid(e,s){return[[5,0],[4,1],[3,2],[2,3],[1,4],[0,5]].some(([t,n])=>e===t&&s===n)}validateSAISDistribution(e,s){return e>=0&&e<=5&&s>=0&&s<=5&&e+s===5&&Number.isInteger(e)&&Number.isInteger(s)}generateConsciousnessProfile(e){let s=s=>{let t=e.find(e=>e.dimension===s),n=this.consciousnessDomains[s][t.preference];return n?{dimension:s,preference:t.preference,percentage:t.consciousnessPercentage||0,arabicDomainName:n.name,consciousnessDescription:n.description}:(console.warn(`No preference data found for ${s}:${t.preference}`),{dimension:s,preference:t.preference,percentage:t.consciousnessPercentage||0,arabicDomainName:t.preference,consciousnessDescription:"وصف غير متاح"})};return{energySourcePattern:s("E/I"),awarenessStyle:s("S/N"),decisionMakingCenter:s("T/F"),lifeStructurePreference:s("J/P")}}testSAISScoring(e){console.log("SAIS Scoring Test:"),console.log("==================");let s=this.calculateMBTI({sessionId:"test-session",responses:e,methodology:"sais",isInterim:!1});console.log("MBTI Type:",s.mbtiType),console.log("Overall Confidence:",s.overallConfidence+"%"),console.log("\nDimension Breakdown:"),s.dimensionScores.forEach(e=>{console.log(`${e.dimension}: ${e.preference} (${e.confidence}% confidence)`),console.log(`  Raw scores: A=${e.rawScoreA}, B=${e.rawScoreB}`),e.consciousnessPercentage&&console.log(`  Consciousness: ${e.consciousnessPercentage}% - ${e.consciousnessDomain}`)}),s.consciousnessProfile&&(console.log("\nConsciousness Profile:"),console.log("Energy Source:",s.consciousnessProfile.energySourcePattern.arabicDomainName,`(${s.consciousnessProfile.energySourcePattern.percentage}%)`),console.log("Awareness Style:",s.consciousnessProfile.awarenessStyle.arabicDomainName,`(${s.consciousnessProfile.awarenessStyle.percentage}%)`),console.log("Decision Center:",s.consciousnessProfile.decisionMakingCenter.arabicDomainName,`(${s.consciousnessProfile.decisionMakingCenter.percentage}%)`),console.log("Life Structure:",s.consciousnessProfile.lifeStructurePreference.arabicDomainName,`(${s.consciousnessProfile.lifeStructurePreference.percentage}%)`))}}}};var s=require("../../../../webpack-runtime.js");s.C(e);var t=e=>s(s.s=e),n=s.X(0,[276,972],()=>t(3350));module.exports=n})();