# Story 2.4B: Server Backup & Advanced Persistence (Post-MVP)

## Status
Draft (POST MVP)

## Story
**As a** user taking extended assessments,  
**I want** server-side backup and advanced persistence features,  
**so that** my progress is protected against any client-side failures and I have visibility into save status.

## Acceptance Criteria (Post-MVP)
1. Server-side backup API stores assessment state every 2 questions during extended assessment
2. Backup system handles failures gracefully with retry logic and user notifications
3. Advanced error handling provides clear messaging and recovery options for storage failures
4. Offline mode detection guides users when network connectivity is lost
5. Storage health monitoring proactively notifies users of potential issues
6. Manual backup triggers give users control over save operations
7. Backup conflict resolution handles concurrent tab scenarios
8. Performance monitoring tracks persistence and recovery usage patterns

## Dev Notes

### Previous Story Context
From Story 2.4A (MVP) completion:
- Enhanced client-side persistence with 48-hour extended sessions
- Format-specific progress tracking for SAIS vs binary formats
- Improved recovery system with exact position continuation
- Optimized client-side storage for SAIS distribution data
- Multi-layer storage with graceful fallback maintained

### Post-MVP Enhancement Focus
This story adds **server-side infrastructure** and **operational excellence** features that were deferred from the MVP to reduce complexity while maintaining full client-side functionality.

### Server-Side Backup Architecture
**Every 2 Questions Backup Strategy** (AC: 1):
- Trigger server backup after questions: 2, 4, 6, 8, 10, 12, 14, 16
- Compress and send only essential progress data to minimize server load
- Include format type, current position, response data, interim results, session metadata
- Handle backup failures gracefully without blocking assessment flow
- Store backups with session expiration aligned with client-side logic (48 hours)

**Backup Data Structure**:
```typescript
interface ServerBackup {
  sessionId: string;
  backupId: string;
  backupTimestamp: Date;
  questionNumber: number;
  assessmentPhase: 'core' | 'extended';
  selectedFormat: 'scenarios' | 'traits' | 'sais' | null;
  compressedState: {
    coreResponses: QuestionResponse[];
    extendedResponses: QuestionResponse[];
    currentPosition: number;
    interimResults?: InterimResults;
    progress: number;
  };
  clientMetadata: {
    userAgent: string;
    lastClientSave: Date;
    storageHealth: StorageHealth;
  };
}
```

### Advanced Error Handling System
**User Notification Framework** (AC: 2, 3):
- Toast notifications for save status and errors
- Progressive error messaging (warning â†’ error â†’ critical)
- Clear action buttons for retry, manual save, and help
- Contextual error explanations based on failure type

**Retry Logic with Exponential Backoff** (AC: 2):
- Initial retry: 1 second delay
- Progressive backoff: 2s, 4s, 8s, 16s, 30s max
- Circuit breaker pattern for persistent failures
- Graceful degradation to client-only mode

### Offline Mode Detection
**Network Connectivity Monitoring** (AC: 4):
- Browser Navigator API integration for online/offline detection
- Periodic connectivity checks during extended sessions  
- Offline mode UI indicators and guidance
- Automatic sync when connectivity returns

### File Locations (Post-MVP)
Based on established architecture patterns:
- **Server Backup API**: `src/app/api/assessment/backup/route.ts` (create)
- **Backup Service**: `src/lib/services/BackupService.ts` (create)
- **Notification System**: `src/lib/services/NotificationService.ts` (create)
- **Offline Detection**: `src/lib/hooks/useNetworkStatus.ts` (create)
- **Performance Monitoring**: `src/lib/services/PerformanceService.ts` (create)
- **Enhanced Recovery**: Update existing `RecoveryDialog.tsx` with server backup options

### Architecture Compliance
**Server API Design** [Source: established patterns]:
- RESTful endpoints following existing API conventions
- Edge Runtime compatible for Vercel deployment
- Proper error handling with structured responses
- Input validation and sanitization
- Rate limiting for backup endpoints

**Client Integration**:
- Non-blocking integration with existing client-side persistence
- Progressive enhancement approach - degrades gracefully if server unavailable
- Maintains existing StorageService and assessment store architecture

## Tasks / Subtasks (Post-MVP)

- [ ] **Task 1: Create Server-Side Backup API** (AC: 1, 2)
  - [ ] Create `src/app/api/assessment/backup/route.ts` with POST/GET endpoints
  - [ ] Implement backup trigger every 2 questions during extended assessment
  - [ ] Add compressed backup data structure with essential progress data
  - [ ] Create `src/lib/services/BackupService.ts` for client-server backup coordination
  - [ ] Add backup failure handling with retry logic and circuit breaker pattern
  - [ ] Implement backup data validation and corruption detection

- [ ] **Task 2: Implement Advanced Error Handling System** (AC: 2, 3, 6)
  - [ ] Create `src/lib/services/NotificationService.ts` for user notification management
  - [ ] Add toast notification system for save status, errors, and confirmations
  - [ ] Implement progressive error messaging (warning â†’ error â†’ critical)
  - [ ] Create manual backup triggers and save status indicators for user control
  - [ ] Add contextual error explanations and recovery guidance
  - [ ] Implement retry options with exponential backoff and user feedback

- [ ] **Task 3: Build Offline Mode Detection & Handling** (AC: 4)
  - [ ] Create `src/lib/hooks/useNetworkStatus.ts` for connectivity monitoring
  - [ ] Add offline mode detection using Navigator API and periodic checks
  - [ ] Implement offline mode UI indicators and user guidance
  - [ ] Create automatic sync when connectivity returns with conflict resolution
  - [ ] Add offline queue for failed backup operations
  - [ ] Test offline/online transitions during extended assessment

- [ ] **Task 4: Implement Storage Health Monitoring** (AC: 5)
  - [ ] Enhance existing StorageService with proactive health monitoring
  - [ ] Add storage quota monitoring with user notifications before limits reached  
  - [ ] Implement storage performance monitoring for slow operations
  - [ ] Create health status indicators in assessment interface
  - [ ] Add preventive storage cleanup and optimization suggestions
  - [ ] Monitor and alert on storage corruption or data inconsistencies

- [ ] **Task 5: Build Backup Conflict Resolution** (AC: 7)
  - [ ] Implement detection of concurrent tab scenarios with assessment state conflicts
  - [ ] Create conflict resolution UI for user decision (local vs server vs merge)
  - [ ] Add backup versioning to support conflict resolution
  - [ ] Implement session locking mechanism for active assessment prevention
  - [ ] Create backup comparison interface showing differences between states
  - [ ] Add automated conflict resolution for simple scenarios (most recent wins)

- [ ] **Task 6: Add Performance Monitoring & Analytics** (AC: 8)
  - [ ] Create `src/lib/services/PerformanceService.ts` for persistence metrics
  - [ ] Track persistence and recovery usage patterns and performance
  - [ ] Monitor backup success/failure rates and recovery time
  - [ ] Add user behavior analytics for persistence preferences (manual vs auto)
  - [ ] Implement performance dashboards for operational monitoring
  - [ ] Create alerts for degraded persistence performance or high failure rates

## Architecture Compliance Notes (Post-MVP)
- **Progressive Enhancement**: Server features enhance but don't break client-side functionality
- **API Design**: Server backup API follows established REST patterns and error handling conventions
- **Performance**: Backup operations are non-blocking and don't impact assessment user experience
- **Security**: Backup data is properly sanitized and validated before storage
- **Scalability**: Backup system designed to handle concurrent users with proper rate limiting

## Benefits of Post-MVP Approach
**MVP Benefits (2.4A):**
- âœ… Immediate value: Enhanced client-side persistence supports SAIS complexity
- âœ… Reduced complexity: No server infrastructure dependencies
- âœ… Fast delivery: Builds on existing StorageService architecture
- âœ… User-focused: 48-hour sessions and improved recovery solve core user needs

**Post-MVP Benefits (2.4B):**
- ðŸš€ **Operational Excellence**: Server backup provides additional safety net
- ðŸš€ **User Confidence**: Visual save status and manual backup controls
- ðŸš€ **Resilience**: Offline mode handling and advanced error recovery
- ðŸš€ **Insights**: Performance monitoring and usage analytics
- ðŸš€ **Polish**: Professional-grade persistence experience

## Dev Agent Record

### Implementation Notes
*[This section will be populated by the Developer Agent during implementation]*

### Testing Validation
*[This section will be populated during implementation with test results]*

### Debug Log References
*[This section will be populated with any debug logs or issues encountered]*

### File List
*[This section will be populated with the complete list of files created or modified]*

### Change Log
*[This section will be populated with detailed changes made to existing files]*
