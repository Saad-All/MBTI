# Story 2.11: Next.js Metadata Configuration Fixes

## Status
Draft

## Story
**As a** developer deploying the MBTI application to production,  
**I want** all Next.js metadata warnings resolved by properly configuring viewport and themeColor exports,  
**so that** the application deploys without metadata configuration warnings and follows Next.js 14+ best practices.

## Acceptance Criteria
1. All "Unsupported metadata viewport" warnings resolved by moving viewport configuration to proper viewport export
2. All "Unsupported metadata themeColor" warnings resolved by moving themeColor to viewport export instead of metadata export
3. Metadata configuration follows Next.js 14+ API reference standards for viewport and theme configuration
4. Application maintains proper PWA configuration with correct viewport and theme color settings
5. All affected pages (assessment/processing, results/sais, favicon.ico) have properly configured metadata exports
6. Build process completes without metadata configuration warnings
7. Mobile viewport behavior remains consistent with proper scaling and theme color display
8. Dark mode theme color configuration works correctly across all routes

## Dev Notes

### Critical Metadata Warnings Identified

**From Development Server Output Analysis:**

#### Multiple Viewport Configuration Warnings
```bash
⚠ Unsupported metadata viewport is configured in metadata export in /ar/assessment/processing
⚠ Unsupported metadata viewport is configured in metadata export in /favicon.ico  
⚠ Unsupported metadata viewport is configured in metadata export in /ar/results/sais
```

#### Multiple ThemeColor Configuration Warnings  
```bash
⚠ Unsupported metadata themeColor is configured in metadata export in /ar/assessment/processing
⚠ Unsupported metadata themeColor is configured in metadata export in /favicon.ico
⚠ Unsupported metadata themeColor is configured in metadata export in /ar/results/sais
```

**Root Cause:** Next.js 14+ requires `viewport` and `themeColor` properties to be exported from a separate `generateViewport` function rather than included in the main `metadata` export.

### Next.js 14+ Metadata API Requirements

**Current (Deprecated) Pattern:**
```typescript
// ❌ WRONG: viewport and themeColor in metadata export
export const metadata: Metadata = {
  title: "MBTI Assessment",
  description: "...",
  viewport: {
    width: 'device-width',
    initialScale: 1,
    maximumScale: 1,
  },
  themeColor: [
    { media: '(prefers-color-scheme: light)', color: '#4F46E5' },
    { media: '(prefers-color-scheme: dark)', color: '#1E1B4B' },
  ],
};
```

**Required (Next.js 14+) Pattern:**
```typescript
// ✅ CORRECT: Separate metadata and viewport exports
export const metadata: Metadata = {
  title: "MBTI Assessment",
  description: "...",
  // viewport and themeColor removed from here
};

export const viewport: Viewport = {
  width: 'device-width',
  initialScale: 1,
  maximumScale: 1,
  themeColor: [
    { media: '(prefers-color-scheme: light)', color: '#4F46E5' },
    { media: '(prefers-color-scheme: dark)', color: '#1E1B4B' },
  ],
};
```

### Affected Files Analysis
**From Terminal Output Pattern Matching:**

**Root Layout Files:**
- `src/app/[locale]/layout.tsx` - Likely contains the main metadata configuration
- `src/app/[locale]/assessment/processing/layout.tsx` or `page.tsx` - Processing route metadata
- `src/app/[locale]/results/sais/layout.tsx` or `page.tsx` - SAIS results route metadata

**Favicon Configuration:**
- Root layout or app configuration affecting favicon.ico route metadata

### Next.js API Reference Compliance
**From Next.js Documentation** [Source: https://nextjs.org/docs/app/api-reference/functions/generate-viewport]:

**Required Import:**
```typescript
import type { Viewport } from 'next'
```

**Viewport Export Function:**
```typescript
export const viewport: Viewport = {
  width: 'device-width',
  initialScale: 1,
  maximumScale: 1,
  userScalable: false,
  viewportFit: 'cover',
  themeColor: [
    { media: '(prefers-color-scheme: light)', color: '#4F46E5' },
    { media: '(prefers-color-scheme: dark)', color: '#1E1B4B' },
  ],
}
```

### PWA and Mobile Configuration Requirements
**From Front-End Specification** [Source: docs/front-end-spec.md]:
- Mobile-first responsive design with proper viewport configuration
- Dark mode theme color support for consistent branding
- PWA capabilities with proper meta configuration

### File Locations and Resolution Strategy
**Files Requiring Metadata Configuration Fixes:**
- `src/app/[locale]/layout.tsx` - Main layout metadata separation
- `src/app/[locale]/assessment/processing/page.tsx` - Processing route metadata fix
- `src/app/[locale]/results/sais/page.tsx` - SAIS results route metadata fix
- Any additional route files with metadata exports containing viewport or themeColor

## Tasks / Subtasks

- [ ] **Task 1: Fix Root Layout Metadata Configuration** (AC: 1, 2, 3, 4)
  - [ ] Analyze current metadata export in `src/app/[locale]/layout.tsx`
  - [ ] Move viewport configuration from metadata export to separate viewport export
  - [ ] Move themeColor configuration from metadata export to viewport export
  - [ ] Import Viewport type from 'next' for proper TypeScript support
  - [ ] Verify PWA configuration remains intact with new metadata structure
  - [ ] Test viewport behavior on mobile devices with proper scaling and theme colors

- [ ] **Task 2: Fix Assessment Processing Route Metadata** (AC: 1, 2, 5)
  - [ ] Locate metadata configuration in assessment processing route causing warnings
  - [ ] Separate viewport and themeColor from metadata export to viewport export
  - [ ] Ensure processing page maintains proper mobile viewport configuration
  - [ ] Verify theme color displays correctly during assessment processing
  - [ ] Test route-specific metadata doesn't conflict with root layout configuration
  - [ ] Validate assessment flow continues working with fixed metadata

- [ ] **Task 3: Fix SAIS Results Route Metadata** (AC: 1, 2, 5, 7)
  - [ ] Identify metadata configuration in SAIS results route causing warnings
  - [ ] Move viewport and themeColor from metadata to viewport export
  - [ ] Ensure SAIS results page maintains proper mobile responsiveness
  - [ ] Verify Arabic RTL layout works correctly with new viewport configuration
  - [ ] Test theme color consistency across SAIS consciousness-focused results
  - [ ] Validate results display functionality after metadata configuration changes

- [ ] **Task 4: Resolve Favicon Route Metadata Issues** (AC: 1, 2, 3)
  - [ ] Investigate favicon.ico route metadata configuration warnings
  - [ ] Fix any global metadata configuration affecting favicon route
  - [ ] Ensure favicon displays correctly with proper theme color support
  - [ ] Verify favicon metadata doesn't interfere with page-specific configurations
  - [ ] Test favicon loading and display across different themes and devices
  - [ ] Remove any redundant metadata exports affecting favicon route

- [ ] **Task 5: Verify Next.js 14+ Compliance and Build Process** (AC: 3, 6, 8)
  - [ ] Run Next.js build process to verify all metadata warnings resolved
  - [ ] Test development server shows no metadata configuration warnings
  - [ ] Verify viewport export pattern follows Next.js 14+ API reference exactly
  - [ ] Test themeColor configuration works correctly in both light and dark modes
  - [ ] Validate mobile viewport behavior with new configuration structure
  - [ ] Ensure production build process completes without metadata warnings

- [ ] **Task 6: Test Mobile and Theme Configuration** (AC: 4, 7, 8)
  - [ ] Test viewport configuration on actual mobile devices (iOS Safari, Android Chrome)
  - [ ] Verify theme color displays correctly in browser chrome and PWA mode
  - [ ] Test dark mode theme color switching works properly across all routes
  - [ ] Validate mobile scaling behavior with userScalable and viewportFit settings
  - [ ] Test PWA installation and theme color consistency
  - [ ] Ensure Arabic RTL layout works correctly with new viewport configuration

### Testing
**Testing Requirements:**
- Build process verification: `npm run build` must complete without metadata warnings
- Development server: `npm run dev` must show no unsupported metadata warnings
- Mobile testing: Verify viewport and theme color configuration on actual devices
- PWA testing: Ensure proper theme color and viewport in progressive web app mode
- Cross-browser testing: Verify metadata configuration works across Chrome, Firefox, Safari, Edge

**Test Commands:**
```bash
# Verify no metadata warnings
npm run dev 2>&1 | grep -i "unsupported metadata"  # Should return empty

# Verify build success
npm run build  # Should complete without metadata warnings

# Verify TypeScript compilation
npx tsc --noEmit  # Should pass without errors
```

## Rollback Strategy & Risk Mitigation

### Critical Risk Assessment
**Primary Risks:**
1. **Viewport Configuration Breaking Mobile Experience** - Incorrect viewport export affecting mobile scaling
2. **Theme Color Configuration Issues** - Theme colors not displaying properly in browsers
3. **PWA Functionality Degradation** - Metadata changes affecting progressive web app features
4. **Route-Specific Metadata Conflicts** - Individual page metadata interfering with global configuration

### Rollback Procedures

#### Task 1-3: Metadata Configuration Rollback
**Trigger Conditions:**
- Mobile viewport behavior breaking or scaling incorrectly
- Theme colors not displaying properly in browser chrome
- PWA installation or functionality affected by metadata changes
- Arabic RTL layout issues caused by viewport configuration changes

**Rollback Steps:**
```bash
# 1. Revert metadata configuration files
git checkout HEAD~1 src/app/[locale]/layout.tsx
git checkout HEAD~1 src/app/[locale]/assessment/processing/
git checkout HEAD~1 src/app/[locale]/results/sais/

# 2. Verify application functionality
npm run dev  # Accept warnings temporarily

# 3. Plan alternative metadata configuration approach
```

**Recovery Time:** <20 minutes with direct file reversion

### Feature Flag Implementation
```typescript
// Metadata configuration safety flags
const METADATA_FIX_FLAGS = {
  ENABLE_VIEWPORT_EXPORT: process.env.NEXT_PUBLIC_ENABLE_VIEWPORT_EXPORT === 'true',
  ENABLE_SEPARATED_THEME_COLOR: process.env.NEXT_PUBLIC_ENABLE_SEPARATED_THEME_COLOR === 'true'
};

// Conditional metadata configuration
export const metadata: Metadata = {
  // Standard metadata only
};

export const viewport: Viewport = METADATA_FIX_FLAGS.ENABLE_VIEWPORT_EXPORT ? {
  // New viewport configuration
} : undefined;
```

### Success Validation
- [ ] `npm run dev` shows no "Unsupported metadata" warnings
- [ ] `npm run build` completes successfully without metadata warnings
- [ ] Mobile viewport behavior works correctly on iOS Safari and Android Chrome
- [ ] Theme color displays properly in browser chrome and PWA mode
- [ ] Dark mode theme switching works correctly across all routes
- [ ] Arabic RTL layout maintains proper viewport configuration

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-01-26 | 1.0 | Initial story creation for Next.js metadata configuration fixes | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
*[This section will be populated by the Developer Agent during implementation]*

### Debug Log References  
*[This section will be populated with any debug logs or traces generated during development]*

### Completion Notes List
*[This section will be populated with notes about the completion of tasks and any issues encountered]*

### File List
*[This section will be populated with list of all files created, modified, or affected during story implementation]*
